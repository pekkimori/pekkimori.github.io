#!/bin/sh

# Process staged files
git diff --cached --name-status | while read -r status old_path new_path; do
  file_to_process=""
  operation_type=""

  # Determine the file path and operation type from the status
  case "$status" in
    A)
      file_to_process="$old_path"
      operation_type="A"
      ;;
    M)
      file_to_process="$old_path"
      operation_type="M"
      ;;
    R*) # Handle rename statuses like R100
      file_to_process="$new_path"
      # Treat a rename as a modification for updating timestamps
      operation_type="M"
      ;;
  esac

  # Proceed if we have a file to process
  if [ -n "$file_to_process" ]; then
    # Check if the file is a blog post
    if echo "$file_to_process" | grep -qE '^src/data/blog/.*\.(md|mdx)$'; then
      # Check if the post is not a draft by looking for "draft: false"
      if grep -q "draft: false" "$file_to_process"; then
        current_time=$(date -u "+%Y-%m-%dT%H:%M:%SZ")

        case "$operation_type" in
          A)
            echo "Updating pubDatetime and modDatetime for new file: $file_to_process"
            # For new files, set both pubDatetime and modDatetime
            sed -i \
              -e "/---.*/,/---.*/s/^pubDatetime:.*$/pubDatetime: $current_time/" \
              -e "/---.*/,/---.*/s/^modDatetime:.*$/modDatetime: $current_time/" \
              "$file_to_process"
            git add "$file_to_process"
            ;;
          M)
            # If the post was a draft and is now being published, update pubDatetime
            if grep -q "pubDatetime: 0000-00-00T00:00:00Z" "$file_to_process"; then
              echo "Updating pubDatetime and modDatetime for published draft: $file_to_process"
              sed -i \
                -e "/---.*/,/---.*/s/^pubDatetime:.*$/pubDatetime: $current_time/" \
                -e "/---.*/,/---.*/s/^modDatetime:.*$/modDatetime: $current_time/" \
                "$file_to_process"
            else
              echo "Updating modDatetime for modified file: $file_to_process"
              # For other modified files, only update modDatetime
              sed -i "/---.*/,/---.*/s/^modDatetime:.*$/modDatetime: $current_time/" "$file_to_process"
            fi
            git add "$file_to_process"
            ;;
        esac
      fi
    fi
  fi
done
